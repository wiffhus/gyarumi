<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ぎゃるみ - Gal AI Chatbot</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; position: fixed; -webkit-text-size-adjust: 100%;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', 'Yu Gothic', YuGothic, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; touch-action: pan-y;
        }
        .chat-container {
            width: 100vw; height: 100vh; height: 100dvh; max-width: 500px; background: #fafafa; display: flex; flex-direction: column; overflow: hidden; position: relative;
        }
        .chat-header {
            position: fixed; top: 0; left: 50%; transform: translateX(-50%); width: 100vw; max-width: 500px; background: linear-gradient(135deg, #a0b3e0 0%, #9fa8c7 100%); background-size: cover; background-position: center; padding: 20px; color: white; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); z-index: 100; transition: background-image 0.8s ease; height: 85px; flex-shrink: 0;
        }
        .chat-header.vibes-low { background-image: url('vibes_low.jpg'); }
        .chat-header.vibes-medium { background-image: url('vibes_med.jpg'); }
        .chat-header.vibes-high { background-image: url('vibes_high.jpg'); }
        .chat-header:not([class*="vibes-"]) { background: linear-gradient(135deg, #a0b3e0 0%, #9fa8c7 100%); }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; transition: transform 0.3s ease; flex-shrink: 0; overflow: hidden; border: 2px solid rgba(255, 255, 255, 0.5); }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .avatar:hover { transform: scale(1.1); }
        .avatar:active { transform: scale(0.95); }
        .bot-info { flex-grow: 1; }
        .bot-name { font-size: 18px; font-weight: bold; margin-bottom: 3px; }
        .vibe-indicator { background: rgba(255, 255, 255, 0.3); padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; cursor: pointer; transition: background 0.3s; flex-shrink: 0; }
        .vibe-indicator:hover { background: rgba(255, 255, 255, 0.4); }
        .trash-button, .user-button { width: 35px; height: 35px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.3s, transform 0.2s; flex-shrink: 0; }
        .trash-button:hover, .user-button:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
        .trash-button:active, .user-button:active { transform: scale(0.95); }
        .trash-button svg, .user-button svg { width: 18px; height: 18px; stroke-width: 2; }
        .profile-display-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .profile-display-modal.active { display: flex; }
        .profile-display-content { background: white; border-radius: 20px; padding: 40px; width: 90%; max-width: 400px; text-align: center; animation: scaleIn 0.3s ease; }
        .profile-avatar-large { width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 20px; overflow: hidden; border: 4px solid #667eea; }
        .profile-avatar-large img { width: 100%; height: 100%; object-fit: cover; }
        .profile-display-name { font-size: 28px; font-weight: bold; color: #667eea; margin-bottom: 15px; }
        .profile-display-greeting { font-size: 16px; color: #666; line-height: 1.6; margin-bottom: 30px; }
        .profile-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .profile-modal.active { display: flex; }
        .profile-modal-content { background: white; border-radius: 20px; padding: 40px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .profile-modal-title { font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 20px; text-align: center; }
        .profile-form-group { margin-bottom: 20px; }
        .profile-form-label { display: block; font-size: 14px; font-weight: bold; color: #333; margin-bottom: 8px; }
        .profile-form-input, .profile-form-select, .profile-form-textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: border-color 0.3s; }
        .profile-form-input:focus, .profile-form-select:focus, .profile-form-textarea:focus { outline: none; border-color: #667eea; }
        .profile-form-textarea { resize: vertical; min-height: 80px; }
        .profile-form-buttons { display: flex; gap: 10px; margin-top: 30px; }
        .profile-form-button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: opacity 0.3s; }
        .profile-form-button.save { background: #667eea; color: white; }
        .profile-form-button.cancel { background: #e0e0e0; color: #333; }
        .profile-form-button:hover { opacity: 0.8; }
        .close-modal-button { background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; cursor: pointer; transition: opacity 0.3s; }
        .close-modal-button:hover { opacity: 0.8; }
        .messages-container {
            flex: 1; overflow-y: auto; padding: 20px; padding-top: 105px; padding-bottom: 100px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; overscroll-behavior: contain;
        }
        .message { margin-bottom: 15px; display: flex; flex-direction: column; animation: slideIn 0.3s ease; }
        .message-user { align-items: flex-end; }
        .message-bot { align-items: flex-start; }
        .message-user > div:not(.message-time), .message-bot > div:not(.message-time) { max-width: 75%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; line-height: 1.4; } /* Adjusted selector */
        .message-user > div:not(.message-time) { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-right-radius: 4px; } /* Adjusted selector */
        .message-bot > div:not(.message-time) { background: white; color: #333; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); } /* Adjusted selector */
        .message-time { font-size: 11px; color: #999; margin-top: 4px; padding: 0 4px; }
        .message-image { max-width: 100%; max-height: 300px; border-radius: 12px; margin-top: 5px; cursor: pointer; transition: transform 0.2s; display: block; } /* margin-bottom removed, margin-top added */
        /* Style for message container holding only an image */
        .message-bot > div.image-only-container,
        .message-user > div.image-only-container {
             background: none !important; box-shadow: none !important; padding: 0 !important; max-width: 75% !important; border-radius: 12px !important; overflow: hidden !important; /* Ensure image fits radius */
        }
        .image-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1000; justify-content: center; align-items: center; animation: fadeIn 0.3s ease; }
        .image-modal.active { display: flex; }
        .image-modal-content { max-width: 90%; max-height: 90%; object-fit: contain; animation: scaleIn 0.3s ease; }
        .typing-indicator { display: none; padding: 12px 16px; background: white; border-radius: 18px; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); width: fit-content; margin-bottom: 15px; }
        .typing-indicator.active { display: flex; gap: 4px; align-items: center; }
        .dot { width: 8px; height: 8px; background: #999; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        .input-container {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100vw; max-width: 500px; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1); z-index: 10; flex-shrink: 0;
        }
        .input-wrapper { display: flex; align-items: flex-end; gap: 10px; background: #f5f5f5; border-radius: 25px; padding: 8px 15px; }
        .input-actions { display: flex; gap: 8px; align-items: center; }
        .action-button { width: 36px; height: 36px; border-radius: 50%; background: transparent; border: none; color: #667eea; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.3s, transform 0.2s; flex-shrink: 0; }
        .action-button:hover { background: rgba(102, 126, 234, 0.1); transform: scale(1.05); }
        .action-button:active { transform: scale(0.95); }
        .action-button.active { background: rgba(102, 126, 234, 0.2); color: #5566d6; }
        .action-button svg { width: 20px; height: 20px; stroke-width: 2; }
        #imageInput { display: none; }
        .image-preview-container { position: relative; display: none; margin-bottom: 10px; }
        .image-preview-container.active { display: block; }
        .image-preview { max-width: 150px; max-height: 150px; border-radius: 12px; border: 2px solid #667eea; }
        .remove-image { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; border-radius: 50%; background: #ff4757; color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; transition: transform 0.2s; }
        .remove-image:hover { transform: scale(1.1); }
        #messageInput {
            flex: 1; border: none; background: transparent; font-size: 16px; resize: none; outline: none; max-height: 100px; overflow-y: auto; font-family: inherit; line-height: 1.4; padding: 6px 0; -webkit-appearance: none;
        }
        #messageInput::placeholder { color: #999; }
        .send-button { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s, opacity 0.3s, background 0.3s; flex-shrink: 0; }
        .send-button:hover:not(:disabled) { transform: scale(1.05); }
        .send-button:active:not(:disabled) { transform: scale(0.95); }
        .send-button:disabled { background: #ccc; opacity: 0.7; cursor: not-allowed; transform: none; } /* Adjusted disabled style */
        .send-button svg { width: 18px; height: 18px; stroke-width: 2.5; }
        .mode-badge { display: none; padding: 4px 12px; background: rgba(102, 126, 234, 0.1); color: #667eea; border-radius: 15px; font-size: 12px; font-weight: bold; margin-bottom: 8px; align-items: center; gap: 6px; }
        .mode-badge.active { display: flex; }
        .mode-badge svg { width: 14px; height: 14px; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @media (max-width: 500px) { .chat-container { max-width: 100%; } }
    </style>
</head>
<body>
    <script>
      // ★★★ GASのURL (忘れずに入力してね！) ★★★
      const GAS_WEB_APP_URL = 'ここにGASのウェブアプリURLを貼り付けてね';
    </script>
    <div class="chat-container">
        <div class="chat-header" id="chatHeader">
            <div class="avatar" id="avatarButton"><img src="profile.jpg" alt="ぎゃるみ"></div>
            <div class="bot-info"><div class="bot-name">ぎゃるみ</div></div>
            <div class="vibe-indicator" id="vibeIndicator">Vibes: 😐</div>
            <button class="user-button" id="userButton" title="プロフィール設定">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            </button>
            <button class="trash-button" id="trashButton" title="会話をクリア">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </button>
        </div>
        <div class="messages-container" id="messagesContainer">
            <div class="typing-indicator" id="typingIndicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        </div>
        <div class="input-container">
            <div class="image-preview-container" id="imagePreviewContainer">
                <img id="imagePreview" class="image-preview" alt="Preview">
                <button class="remove-image" id="removeImage">×</button>
            </div>
            <div class="mode-badge" id="modeBadge">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>
                おえかきモード
            </div>
            <div class="input-wrapper">
                <div class="input-actions">
                    <input type="file" id="imageInput" accept="image/*">
                    <button class="action-button" id="imageButton" title="画像を送る">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    </button>
                    <button class="action-button" id="drawButton" title="おえかき">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>
                    </button>
                </div>
                <textarea id="messageInput" placeholder="メッセージを入力..." rows="1"></textarea>
                <button class="send-button" id="sendButton" disabled> {/* ★ disabled 追加 */}
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </div>
        </div>
    </div>
    <div class="image-modal" id="imageModal"><img id="imageModalContent" class="image-modal-content" alt="Full size"></div>
    <div class="profile-display-modal" id="profileDisplayModal">
        <div class="profile-display-content">
            <div class="profile-avatar-large"><img src="full.jpg" alt="ぎゃるみ"></div>
            <div class="profile-display-name">ぎゃるみ</div>
            <div class="profile-display-greeting">まじ最高じゃん！✨<br>いろんな話しよ〜💕<br>なんでも聞いてね！</div>
            <button class="close-modal-button" id="closeProfileDisplay">閉じる</button>
        </div>
    </div>
    <div class="profile-modal" id="profileModal">
        <div class="profile-modal-content">
            <div class="profile-modal-title">あなたのプロフィール</div>
            <form id="profileForm">
                <div class="profile-form-group"><label class="profile-form-label">名前</label><input type="text" class="profile-form-input" id="profileName" placeholder="ニックネームでOK！"></div>
                <div class="profile-form-group"><label class="profile-form-label">年齢</label><input type="number" class="profile-form-input" id="profileAge" placeholder="例: 20"></div>
                <div class="profile-form-group"><label class="profile-form-label">性別</label><select class="profile-form-select" id="profileGender"><option value="">選択してね</option><option value="male">男性</option><option value="female">女性</option><option value="other">その他</option></select></div>
                <div class="profile-form-group"><label class="profile-form-label">趣味・興味</label><input type="text" class="profile-form-input" id="profileInterests" placeholder="例: 音楽、映画、ゲーム"></div>
                <div class="profile-form-group"><label class="profile-form-label">メモ（任意）</label><textarea class="profile-form-textarea" id="profileNotes" placeholder="何か伝えたいことがあれば..."></textarea></div>
                <div class="profile-form-buttons">
                    <button type="button" class="profile-form-button cancel" id="cancelProfile">キャンセル</button>
                    <button type="submit" class="profile-form-button save">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class GyarumiChat {
            constructor() {
                this.messagesContainer = document.getElementById('messagesContainer');
                this.input = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.imageButton = document.getElementById('imageButton');
                this.drawButton = document.getElementById('drawButton');
                this.imageInput = document.getElementById('imageInput');
                this.imagePreviewContainer = document.getElementById('imagePreviewContainer');
                this.imagePreview = document.getElementById('imagePreview');
                this.removeImageButton = document.getElementById('removeImage');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.vibeIndicator = document.getElementById('vibeIndicator');
                this.trashButton = document.getElementById('trashButton');
                this.imageModal = document.getElementById('imageModal');
                this.imageModalContent = document.getElementById('imageModalContent');
                this.chatHeader = document.getElementById('chatHeader');
                this.avatarButton = document.getElementById('avatarButton');
                this.profileDisplayModal = document.getElementById('profileDisplayModal');
                this.closeProfileDisplay = document.getElementById('closeProfileDisplay');
                this.userButton = document.getElementById('userButton');
                this.profileModal = document.getElementById('profileModal');
                this.profileForm = document.getElementById('profileForm');
                this.cancelProfile = document.getElementById('cancelProfile');
                this.modeBadge = document.getElementById('modeBadge');

                this.ERROR_MESSAGE_TEXT = 'ごめん、ちょっと調子悪いかも💦';
                this.messages = [];
                this.conversationHistory = [];
                this.selectedImage = null; // プレビュー用 Base64 URL
                this.selectedImageData = null; // 送信・保存用 Base64 データ (data:...)
                this.isSending = false;
                this.userId = this.loadUserId();
                this.loadMoodFromStorage();
                this.isDrawMode = false;
                this.userProfile = this.loadUserProfile();
                this.init();
            }

            loadUserId() {
                let id = localStorage.getItem('gyarumi_user_id');
                if (!id) { id = 'user_' + Date.now().toString() + Math.random().toString(36).substring(2); localStorage.setItem('gyarumi_user_id', id); }
                console.log('Using User ID:', id); return id;
            }

            async init() {
                this.sendButton.addEventListener('click', () => this.handleSend());
                this.input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey && !e.isComposing) { e.preventDefault(); this.handleSend(); } });
                this.input.addEventListener('input', () => { this.input.style.height = 'auto'; this.input.style.height = this.input.scrollHeight + 'px'; this.updateSendButtonState(); });
                this.imageButton.addEventListener('click', () => this.imageInput.click());
                this.imageInput.addEventListener('change', (e) => this.handleImageSelect(e));
                this.removeImageButton.addEventListener('click', () => this.clearSelectedImage());
                this.drawButton.addEventListener('click', () => this.toggleDrawMode());
                this.imageModal.addEventListener('click', () => this.imageModal.classList.remove('active'));
                this.trashButton.addEventListener('click', () => { if (confirm('会話履歴をリセットしますか？\n(管理者ログはサーバーに残ります)')) { this.clearHistory(); } });
                this.avatarButton.addEventListener('click', () => this.profileDisplayModal.classList.add('active'));
                this.closeProfileDisplay.addEventListener('click', () => this.profileDisplayModal.classList.remove('active'));
                this.profileDisplayModal.addEventListener('click', (e) => { if (e.target === this.profileDisplayModal) { this.profileDisplayModal.classList.remove('active'); } });
                this.userButton.addEventListener('click', () => this.openProfileModal());
                this.cancelProfile.addEventListener('click', () => this.profileModal.classList.remove('active'));
                this.profileForm.addEventListener('submit', (e) => { e.preventDefault(); this.saveUserProfile(); });
                this.profileModal.addEventListener('click', (e) => { if (e.target === this.profileModal) { this.profileModal.classList.remove('active'); } });
                // Mobile adjustments
                this.input.addEventListener('focus', () => { setTimeout(() => { this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight; }, 300); });
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) { this.input.addEventListener('blur', () => { window.scrollTo(0, 0); document.body.scrollTop = 0; }); }

                await this.loadHistoryFromGas();
                this.updateMoodDisplay();
                this.updateSendButtonState(); // Initial state
            }

            // ★ 更新: 送信ボタンの状態更新ロジック
            updateSendButtonState() {
                const text = this.input.value.trim();
                // テキストがある OR 画像選択中 OR (お絵描きモード かつ テキストがある)
                const canSend = text || this.selectedImage || (this.isDrawMode && text);
                this.sendButton.disabled = this.isSending || !canSend;
            }

            toggleDrawMode() {
                this.isDrawMode = !this.isDrawMode;
                if (this.isDrawMode) {
                    this.drawButton.classList.add('active'); this.modeBadge.classList.add('active'); this.input.placeholder = 'どんな絵を描こうか？'; this.clearSelectedImage();
                } else {
                    this.drawButton.classList.remove('active'); this.modeBadge.classList.remove('active'); this.input.placeholder = 'メッセージを入力...';
                }
                this.updateSendButtonState();
            }

            loadUserProfile() { const s = localStorage.getItem('gyarumi_user_profile'); return s ? JSON.parse(s) : {}; }
            saveUserProfileToStorage() { localStorage.setItem('gyarumi_user_profile', JSON.stringify(this.userProfile)); }
            openProfileModal() { document.getElementById('profileName').value=this.userProfile.name||''; document.getElementById('profileAge').value=this.userProfile.age||''; document.getElementById('profileGender').value=this.userProfile.gender||''; document.getElementById('profileInterests').value=this.userProfile.interests||''; document.getElementById('profileNotes').value=this.userProfile.notes||''; this.profileModal.classList.add('active'); }
            saveUserProfile() { this.userProfile={name:document.getElementById('profileName').value.trim(), age:document.getElementById('profileAge').value.trim(), gender:document.getElementById('profileGender').value, interests:document.getElementById('profileInterests').value.trim(), notes:document.getElementById('profileNotes').value.trim()}; this.saveUserProfileToStorage(); this.profileModal.classList.remove('active'); const m={text:'プロフィール保存したよ〜！これからもっと仲良くなれそうだね💕',sender:'bot',timestamp:new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})}; this.messages.push(m); this.displayMessage(m.text,m.sender,m.timestamp); this.scrollToBottom(); }

            handleImageSelect(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    if (this.isDrawMode) { this.toggleDrawMode(); }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        this.selectedImage = event.target.result; // Preview URL
                        this.imagePreview.src = this.selectedImage;
                        this.imagePreviewContainer.classList.add('active');
                        this.selectedImageData = this.selectedImage; // Base64 data (data:...)
                        this.updateSendButtonState(); // Update button state
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = '';
            }
            clearSelectedImage() {
                this.selectedImage = null; this.selectedImageData = null;
                this.imagePreviewContainer.classList.remove('active'); this.imageInput.value = '';
                this.updateSendButtonState(); // Update button state
            }

            saveMoodToStorage() { localStorage.setItem('gyarumi_mood', JSON.stringify({ moodScore: this.moodScore, continuity: this.continuity, relationship: this.relationship })); }
            loadMoodFromStorage() { const s = localStorage.getItem('gyarumi_mood'); if (s) { const m = JSON.parse(s); this.moodScore = m.moodScore || 0; this.continuity = m.continuity || 0; this.relationship = m.relationship || 'LOW'; } }

            async loadHistoryFromGas() {
                console.log('Loading history from GAS for user:', this.userId);
                try {
                    const response = await fetch(`${GAS_WEB_APP_URL}?userId=${this.userId}`);
                    if (!response.ok) throw new Error('Failed to fetch history from GAS');
                    const history = await response.json();
                    this.messages = []; this.conversationHistory = [];
                    let startIndex = 0;
                    if (history.length > 0 && history[0].timestamp === 'Timestamp') { startIndex = 1; console.log('Skipping header row.'); }
                    for (let i = startIndex; i < history.length; i++) {
                        const msg = history[i]; let imageUrl = null;
                        if (msg.imageId) imageUrl = `https://drive.google.com/uc?id=${msg.imageId}`;
                        const textContent = msg.text;
                        const messageData = { text: textContent, sender: msg.speaker, timestamp: msg.timestamp, image: imageUrl };
                        this.messages.push(messageData);
                        this.displayMessage(messageData.text, messageData.sender, messageData.timestamp, messageData.image);
                        let aiHistoryContent = textContent || ''; if (imageUrl) aiHistoryContent = (aiHistoryContent + ' (画像あり)').trim();
                        if (msg.speaker === 'user') { this.conversationHistory.push({ role: 'user', content: aiHistoryContent }); }
                        else { if (aiHistoryContent && aiHistoryContent !== this.ERROR_MESSAGE_TEXT) { this.conversationHistory.push({ role: 'model', content: aiHistoryContent }); } }
                    }
                    this.scrollToBottom();
                } catch (error) { console.error('Failed to load history:', error); this.displayMessage('履歴の読み込みに失敗... (GAS接続エラー)', 'bot', new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })); }
            }

            async saveMessageToGas(message, errorDetail = null) {
                 console.log('Saving message to GAS:', { message, errorDetail });
                 const payload = { userId: this.userId, timestamp: message.timestamp, speaker: message.sender, text: message.text, imageData: message.image, errorDetail: errorDetail };
                 if (payload.imageData && !payload.imageData.startsWith('data:image')) payload.imageData = null; // Only save Base64
                 if (payload.text === 'プロフィール保存したよ〜！これからもっと仲良くなれそうだね💕') return;
                 if (!payload.text && !payload.imageData && !payload.errorDetail) { console.log('Skipping empty save'); return; }
                 try { fetch(GAS_WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' }, mode: 'no-cors' }); }
                 catch (error) { console.error('Failed to save message to GAS:', error); }
            }

            handleSend() {
                if (this.isSending || this.sendButton.disabled) return;
                this.isSending = true;
                this.sendButton.disabled = true; // Disable button immediately
                setTimeout(() => { this.sendMessage(); }, 0);
            }

            async sendMessage() {
                const text = this.input.value.trim();
                const image = this.selectedImage; // Preview URL
                const imageData = this.selectedImageData; // Base64 data (data:...)
                const isDrawing = this.isDrawMode;

                const userMessage = { text: isDrawing ? `🎨 ${text}` : text, sender: 'user', timestamp: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }), image: image };
                this.messages.push(userMessage);
                this.displayMessage(userMessage.text, userMessage.sender, userMessage.timestamp, userMessage.image);
                this.saveMessageToGas({ ...userMessage, image: imageData }); // Save with Base64

                this.conversationHistory.push({ role: 'user', content: text || '(画像を送信)' });
                this.input.value = ''; this.input.style.height = 'auto'; this.clearSelectedImage(); // Clears preview & updates button state
                this.scrollToBottom(); this.showTyping();

                let responseData = null;
                try {
                    responseData = await this.sendToAPI(text, imageData ? imageData.split(',')[1] : null, isDrawing); // Send Base64 data part
                    this.hideTyping();
                    const isErrorResponse = responseData.errorDetail !== null && responseData.errorDetail !== undefined;
                    const botResponseText = responseData.response;
                    const errorDetailForLog = responseData.errorDetail;

                    if (isErrorResponse) {
                        console.error("Error from API:", errorDetailForLog);
                        const botMessage = { text: botResponseText, sender: 'bot', timestamp: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) };
                        this.messages.push(botMessage); this.displayMessage(botMessage.text, botMessage.sender, botMessage.timestamp); this.saveMessageToGas(botMessage, errorDetailForLog);
                    } else if (responseData.generatedImage) {
                        const timestamp = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                        const botImageMessage = { text: null, sender: 'bot', timestamp: timestamp, image: responseData.generatedImage }; // Base64 from API
                        this.messages.push(botImageMessage); this.displayMessage(botImageMessage.text, botImageMessage.sender, botImageMessage.timestamp, botImageMessage.image); this.saveMessageToGas(botImageMessage); // Save Base64
                        const botTextMessage = { text: botResponseText, sender: 'bot', timestamp: timestamp, image: null };
                        this.messages.push(botTextMessage); this.displayMessage(botTextMessage.text, botTextMessage.sender, botTextMessage.timestamp, botTextMessage.image); this.saveMessageToGas(botTextMessage);
                        this.conversationHistory.push({ role: 'model', content: botResponseText });
                    } else {
                        const botMessage = { text: botResponseText, sender: 'bot', timestamp: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) };
                        this.messages.push(botMessage); this.displayMessage(botMessage.text, botMessage.sender, botMessage.timestamp); this.saveMessageToGas(botMessage);
                        this.conversationHistory.push({ role: 'model', content: botResponseText });
                    }

                    if (responseData) { this.moodScore = responseData.moodScore !== undefined ? responseData.moodScore : this.moodScore; this.continuity = responseData.continuity !== undefined ? responseData.continuity : this.continuity; this.relationship = responseData.relationship || this.relationship; this.updateMoodDisplay(); this.saveMoodToStorage(); }
                    if (this.conversationHistory.length > 20) { this.conversationHistory = this.conversationHistory.slice(-20); }

                } catch (error) { // Catch unexpected errors in sendMessage
                    this.hideTyping();
                    console.error('Critical Error in sendMessage:', error);
                    const ts = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                    const em = { text: this.ERROR_MESSAGE_TEXT, sender: 'bot', timestamp: ts }; this.messages.push(em); this.displayMessage(em.text, em.sender, em.timestamp); this.saveMessageToGas(em, `sendMessage Error: ${error.message}`);
                } finally {
                    this.isSending = false;
                    this.updateSendButtonState(); // Ensure button state is updated after send/error
                    if (isDrawing) { this.toggleDrawMode(); }
                }
                this.scrollToBottom();
            }

            async sendToAPI(text, imageData, isDrawing) {
                 try { const reqBody={message:text, conversationHistory:this.conversationHistory.slice(-10), userProfile:this.userProfile, moodScore:this.moodScore, continuity:this.continuity, isDrawing:isDrawing}; if(imageData){reqBody.image=imageData;} const fetchRes=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(reqBody)}); if(!fetchRes.ok){ const errTxt=await fetchRes.text(); console.error('API Err Resp Txt:',errTxt); try { const errJson=JSON.parse(errTxt); if(errJson.errorDetail){ return {response:errJson.response||this.ERROR_MESSAGE_TEXT, errorDetail:errJson.errorDetail, moodScore:this.moodScore, continuity:this.continuity, relationship:this.relationship, generatedImage:null}; } } catch(pErr){} throw new Error(`API Error: ${fetchRes.status} - ${errTxt.substring(0,100)}`); } const resData=await fetchRes.json(); if(resData.errorDetail){ console.warn('Received err detail from Worker:', resData.errorDetail); } return resData; } catch(error){ console.error('API Fetch/Parse Err:',error); return {response:this.ERROR_MESSAGE_TEXT, errorDetail:`Fetch Error: ${error.message}`, moodScore:this.moodScore, continuity:this.continuity, relationship:this.relationship, generatedImage:null}; }
            }

            displayMessage(text, sender, timestamp, image = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${sender}`;
                let textDiv = ''; if (text) { textDiv = `<div>${text}</div>`; }
                let imageTag = ''; if (image) { imageTag = `<img src="${image}" class="message-image" onclick="chat.showImageModal('${image}')">`; }
                // If only image, wrap it in a div with a specific class for styling
                if (image && !text) {
                     messageDiv.innerHTML = `<div class="image-only-container">${imageTag}</div><div class="message-time">${timestamp}</div>`;
                } else {
                     messageDiv.innerHTML = `${textDiv}${imageTag}<div class="message-time">${timestamp}</div>`;
                }
                this.messagesContainer.insertBefore(messageDiv, this.typingIndicator);
                setTimeout(() => { this.scrollToBottom(); }, 100);
            }

            showImageModal(src) { this.imageModalContent.src=src; this.imageModal.classList.add('active'); }
            showTyping() { this.typingIndicator.classList.add('active'); }
            hideTyping() { this.typingIndicator.classList.remove('active'); }
            updateMoodDisplay() { this.updateVibeIndicator(); this.updateHeaderBackground(); }
            updateVibeIndicator() { const s=this.moodScore; let e=s<-0.3?'😰':s<0.5?'😐':'😆'; this.vibeIndicator.textContent=`Vibes: ${e}`; }
            updateHeaderBackground() { const s=this.moodScore; this.chatHeader.classList.remove('vibes-low','vibes-medium','vibes-high'); if(s<-0.3)this.chatHeader.classList.add('vibes-low'); else if(s<0.5)this.chatHeader.classList.add('vibes-medium'); else this.chatHeader.classList.add('vibes-high'); }

            clearHistory() {
                 this.messages=[]; this.conversationHistory=[]; this.messagesContainer.innerHTML='<div class="typing-indicator" id="typingIndicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>'; this.typingIndicator=document.getElementById('typingIndicator'); this.moodScore=0; this.continuity=0; this.relationship='LOW'; this.updateMoodDisplay(); localStorage.removeItem('gyarumi_mood'); localStorage.removeItem('gyarumi_user_id'); console.log('User ID cleared.'); alert('履歴リセット。リロードして新しいチャットを開始します。'); location.reload();
            }
            scrollToBottom() { this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight; }
        }

        if (typeof GAS_WEB_APP_URL === 'undefined' || GAS_WEB_APP_URL === 'ここにGASのウェブアプリURLを貼り付けてね') { alert('エラー: GAS_WEB_APP_URLが設定されていません。index.htmlの<body>タグ直下を編集してください。'); }
        else { const chat = new GyarumiChat(); }
    </script>
</body>
</html>
