<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’– ä»¤å’Œã‚®ãƒ£ãƒ«AI - ãã‚ƒã‚‹ã¿ ğŸ’–</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fce4ec; } /* ãƒ”ãƒ³ã‚¯ã®èƒŒæ™¯ */
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .gyarumi-bubble { background-color: #ff80ab; color: white; border-top-left-radius: 5px; } /* ã‚®ãƒ£ãƒ«ã¿ã¯æ´¾æ‰‹ãªãƒ”ãƒ³ã‚¯ */
        .user-bubble { background-color: #ffffff; color: #333; border-top-right-radius: 5px; } /* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã‚·ãƒ³ãƒ—ãƒ« */
        #chat-container { height: 75vh; }
    </style>
</head>
<body class="flex flex-col h-screen antialiased">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white p-4 shadow-lg flex items-center justify-between sticky top-0 z-10">
        <h1 class="text-2xl font-bold text-[#ff1493]">ğŸ’– ãã‚ƒã‚‹ã¿ã¨ãƒˆãƒ¼ã‚¯ å</h1>
        <div id="status" class="text-sm text-gray-500 font-medium">åˆæœŸè¨­å®šä¸­...</div>
    </header>

    <!-- ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
    <main id="chat-container" class="flex-grow p-4 overflow-y-auto space-y-4">
        <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        <div class="flex justify-start">
            <div class="chat-bubble gyarumi-bubble text-lg">
                <span class="font-bold">ãã‚ƒã‚‹ã¿:</span> ã“ã‚“ã«ã¡ã¯ãƒ¼ï¼
            </div>
        </div>
    </main>

    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <div class="p-4 bg-white border-t border-pink-200">
        <form id="chat-form" class="flex space-x-3">
            <input type="text" id="user-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." required
                   class="flex-grow p-3 border-2 border-pink-300 rounded-xl focus:outline-none focus:border-[#ff1493] transition duration-200 text-base" />
            <button type="submit" id="send-button"
                    class="bg-[#ff1493] text-white p-3 rounded-xl font-bold hover:bg-[#ff4081] transition duration-200 shadow-md flex items-center justify-center disabled:opacity-50">
                é€ä¿¡
            </button>
        </form>
        <p id="system-info" class="text-xs text-gray-400 mt-2">
            ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ğŸ’– Vibes: 0.0 | Pts: 0.0 | Rel: LOW
        </p>
    </div>

    <script>
        const API_ENDPOINT = '/functions/chat'; 
        const chatForm = document.getElementById('chat-form');
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const systemInfo = document.getElementById('system-info');

        // ğŸš¨ ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã®åˆæœŸè¨­å®š (ãƒ‡ãƒ¢ç”¨: 35æ­³ç”·æ€§ä¼šç¤¾å“¡ã‚’æƒ³å®š)
        let userProfile = {
            gender: 'MALE',
            age_group: '40S_PLUS', 
            style: 'UNCLE',
            relationship: 'LOW',
            affinity_points: 0.0,
            memory_joy: 0.0,
            memory_anxiety: 0.0
        };

        function addMessage(sender, text) {
            const isGyarumi = sender === 'gyarumi';
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isGyarumi ? 'justify-start' : 'justify-end'}`;
            messageDiv.innerHTML = `
                <div class="chat-bubble ${isGyarumi ? 'gyarumi-bubble' : 'user-bubble'} text-lg">
                    ${isGyarumi ? '<span class="font-bold">ãã‚ƒã‚‹ã¿:</span> ' : ''}${text}
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateSystemInfo() {
            systemInfo.innerHTML = `
                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ğŸ’– Vibes: ${userProfile.vibe_score ? userProfile.vibe_score.toFixed(2) : '0.00'} | 
                Pts: ${userProfile.affinity_points.toFixed(1)} | 
                Rel: ${userProfile.relationship} | 
                Mem: J${userProfile.memory_joy.toFixed(1)}/A${userProfile.memory_anxiety.toFixed(1)}
            `;
        }

        async function handleSubmit(event) {
            event.preventDefault();

            const query = userInput.value.trim();
            if (!query) return;

            addMessage('user', query);
            userInput.value = '';
            sendButton.disabled = true;

            try {
                // ğŸš€ æœ€æ–°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¯ã‚¨ãƒªã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€ä¿¡
                const requestPayload = {
                    query: query,
                    userProfile: userProfile
                };

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestPayload)
                });

                if (!response.ok) {
                    throw new Error('API Error: ' + response.statusText);
                }

                const data = await response.json();
                
                // ğŸ’¥ ãã‚ƒã‚‹ã¿ã®å¿œç­”ã¨æœ€æ–°ã®çŠ¶æ…‹ã‚’å—ã‘å–ã‚‹
                addMessage('gyarumi', data.response);
                
                // ğŸš¨ éå¸¸ã«é‡è¦: æœ€æ–°ã®çŠ¶æ…‹ã‚’ä¿å­˜ã—ã¦æ¬¡ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä½¿ã†
                userProfile = data.newState; 
                userProfile.vibe_score = data.vibeScore; // Tanhã®ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
                userProfile.relationship = data.newState.relationship; // æ›´æ–°ã•ã‚ŒãŸè¦ªå¯†åº¦ã‚’åæ˜ 

                updateSystemInfo();
                
            } catch (error) {
                console.error('Fetch Error:', error);
                addMessage('system', 'ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            } finally {
                sendButton.disabled = false;
            }
        }

        chatForm.addEventListener('submit', handleSubmit);
        updateSystemInfo();
        
    </script>
</body>
</html>
