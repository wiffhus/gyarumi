<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>💖 令和ギャルAI - ぎゃるみ 💖</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fce4ec; } /* ピンクの背景 */
        .chat-bubble { max-width: 80%; padding: 10px 15px; border-radius: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .gyarumi-bubble { background-color: #ff80ab; color: white; border-top-left-radius: 5px; } /* ギャルみは派手なピンク */
        .user-bubble { background-color: #ffffff; color: #333; border-top-right-radius: 5px; } /* ユーザーはシンプル */
        #chat-container { height: 75vh; }
    </style>
</head>
<body class="flex flex-col h-screen antialiased">

    <!-- ヘッダー -->
    <header class="bg-white p-4 shadow-lg flex items-center justify-between sticky top-0 z-10">
        <h1 class="text-2xl font-bold text-[#ff1493]">💖 ぎゃるみとトーク 卍</h1>
        <div id="status" class="text-sm text-gray-500 font-medium">初期設定中...</div>
    </header>

    <!-- チャットコンテナ -->
    <main id="chat-container" class="flex-grow p-4 overflow-y-auto space-y-4">
        <!-- チャットメッセージがここに追加される -->
        <div class="flex justify-start">
            <div class="chat-bubble gyarumi-bubble text-lg">
                <span class="font-bold">ぎゃるみ:</span> こんにちはー！
            </div>
        </div>
    </main>

    <!-- 入力エリア -->
    <div class="p-4 bg-white border-t border-pink-200">
        <form id="chat-form" class="flex space-x-3">
            <input type="text" id="user-input" placeholder="メッセージを入力..." required
                   class="flex-grow p-3 border-2 border-pink-300 rounded-xl focus:outline-none focus:border-[#ff1493] transition duration-200 text-base" />
            <button type="submit" id="send-button"
                    class="bg-[#ff1493] text-white p-3 rounded-xl font-bold hover:bg-[#ff4081] transition duration-200 shadow-md flex items-center justify-center disabled:opacity-50">
                送信
            </button>
        </form>
        <p id="system-info" class="text-xs text-gray-400 mt-2">
            ステータス: 💖 Vibes: 0.0 | Pts: 0.0 | Rel: LOW
        </p>
    </div>

    <script>
        const API_ENDPOINT = '/functions/chat'; 
        const chatForm = document.getElementById('chat-form');
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const systemInfo = document.getElementById('system-info');

        // 🚨 ユーザー属性の初期設定 (デモ用: 35歳男性会社員を想定)
        let userProfile = {
            gender: 'MALE',
            age_group: '40S_PLUS', 
            style: 'UNCLE',
            relationship: 'LOW',
            affinity_points: 0.0,
            memory_joy: 0.0,
            memory_anxiety: 0.0
        };

        function addMessage(sender, text) {
            const isGyarumi = sender === 'gyarumi';
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isGyarumi ? 'justify-start' : 'justify-end'}`;
            messageDiv.innerHTML = `
                <div class="chat-bubble ${isGyarumi ? 'gyarumi-bubble' : 'user-bubble'} text-lg">
                    ${isGyarumi ? '<span class="font-bold">ぎゃるみ:</span> ' : ''}${text}
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateSystemInfo() {
            systemInfo.innerHTML = `
                ステータス: 💖 Vibes: ${userProfile.vibe_score ? userProfile.vibe_score.toFixed(2) : '0.00'} | 
                Pts: ${userProfile.affinity_points.toFixed(1)} | 
                Rel: ${userProfile.relationship} | 
                Mem: J${userProfile.memory_joy.toFixed(1)}/A${userProfile.memory_anxiety.toFixed(1)}
            `;
        }

        async function handleSubmit(event) {
            event.preventDefault();

            const query = userInput.value.trim();
            if (!query) return;

            addMessage('user', query);
            userInput.value = '';
            sendButton.disabled = true;

            try {
                // 🚀 最新のユーザープロファイルとクエリをバックエンドに送信
                const requestPayload = {
                    query: query,
                    userProfile: userProfile
                };

                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestPayload)
                });

                if (!response.ok) {
                    throw new Error('API Error: ' + response.statusText);
                }

                const data = await response.json();
                
                // 💥 ぎゃるみの応答と最新の状態を受け取る
                addMessage('gyarumi', data.response);
                
                // 🚨 非常に重要: 最新の状態を保存して次のリクエストに使う
                userProfile = data.newState; 
                userProfile.vibe_score = data.vibeScore; // Tanhのスコアを更新
                userProfile.relationship = data.newState.relationship; // 更新された親密度を反映

                updateSystemInfo();
                
            } catch (error) {
                console.error('Fetch Error:', error);
                addMessage('system', 'エラー: サーバーとの通信に失敗しました。');
            } finally {
                sendButton.disabled = false;
            }
        }

        chatForm.addEventListener('submit', handleSubmit);
        updateSystemInfo();
        
    </script>
</body>
</html>
